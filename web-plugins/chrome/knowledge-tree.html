<html>
<head>
	<meta http-equiv="Content-Type" content="text/html; charset=UTF-8" >
	<title>i2tree Collector</title>
	
	<link rel="stylesheet"	href="http://ajax.googleapis.com/ajax/libs/jqueryui/1.8.16/themes/base/jquery-ui.css" type="text/css" media="all" />
	<style type="text/css">
		body {	font-size: 98.5%;	}		
		body {	font-family: "Trebuchet MS", "Helvetica", "Arial", "Verdana", "sans-serif";	}
		#search_results { margin: 10px 0px;	}
		#search_results > .record {	padding: 10px;	}
		#search_results > .record:HOVER { background: #F5DA81; color: #0404B4; }
	</style>

	<script type="text/javascript" src="http://ajax.googleapis.com/ajax/libs/jquery/1.6.4/jquery.min.js"></script>
	<script type="text/javascript" src="http://ajax.googleapis.com/ajax/libs/jqueryui/1.8.16/jquery-ui.min.js"></script>
	<script type="text/javascript">
		$.extend({
		  getUrlVars: function(){
		    var vars = [], hash;
		    var hashes = window.location.href.slice(window.location.href.indexOf('?') + 1).split('&');
		    for(var i = 0; i < hashes.length; i++)
		    {
		      hash = hashes[i].split('=');
		      vars.push(hash[0]);
		      vars[hash[0]] = decodeURIComponent(hash[1]);
		    }
		    return vars;
		  },
		  getUrlVar: function(name){
		    return $.getUrlVars()[name];
		  }
		});
	</script>
	<script src="http://ajax.microsoft.com/ajax/jquery.templates/beta1/jquery.tmpl.min.js"></script>
</head>
<body>
	
	<div id="name" contenteditable="true"></div>
	<div id="search_results" contenteditable="true"></div>
	
	<a href="javascript:addInfoNode(this)" >addInfoNode</a>
	<img id="ajax_loader" style="display:none;" src="http://drupal.org/files/54640843-ajax-style-loading-gif-animation.gif" />
	
	<script id="searchRecordTpl" type="text/x-jquery-tmpl"> 
    	<div class="record" >
			<a href="${url}" target="_blank"  ><b>${title}</b> </a>
			<p>${description}</p>
			{{each tags}}
        		${$index + 1}: <b>${$value}</b>
   			{{/each}}
		</div> 
	</script>
	
	<script type="text/javascript">	
		var check_status = false;
		var statusUrl = 'http://nguyentantrieu.info/i2tree/index.php/cloud_storage/check_status';
		
		function checkLogin(){
			jQuery.get(statusUrl,{},function(rs) {			
				if(rs === 'false'){
					check_status = false;
				} else {
					check_status = true;
					if(autoPost){
						addInfoNode();
					}
				}
			} );
		}
		checkLogin();
		
		
		chrome.extension.onRequest.addListener(
			function(request, sender, sendResponse) {		
				{
					jQuery('#search_results').html(request.html);
					jQuery('#name').html(request.name);
				}
			}
		);
		
		function popupCenter(pageURL, w, h, top, left, nofocus) {
			if(typeof left === 'undefined' )
				left = (screen.width/2)-(w/2);
			if(typeof top === 'undefined' )
				top = (screen.height/2)-(h/2);
			if(top > 120 ) top -= 70;
			var params = 'menubar=0,resizable=1,toolbar=no,location=no,directories=no,status=yes,menubar=no,scrollbars=no,resizable=yes,copyhistory=no,'; 
			params = params + ('width='+w+', height='+h+', top='+top+', left='+left);
			var win = window.open (pageURL, "_blank", params);
			if(typeof win.focus === 'function' && !nofocus) {
				win.focus();           
			}
			return win;
		}
		
		var autoPost = false;
		function addInfoNode(){
			if( ! check_status ) {
				var myWindow = popupCenter(statusUrl + '?web_login=true',960,600,50);	
				var timer = setInterval(function(){
					if(myWindow.closed){
						checkLogin();
						clearInterval(timer);
					}
				}, 500);
				autoPost = true;
				myWindow.focus();
				return;
			}
			jQuery('#ajax_loader').show();
			var f = function(rs){
				jQuery('#ajax_loader').hide();
			};
			var data = {text: jQuery('#search_results').html(), name : jQuery('#name').text() };
			jQuery.post('http://nguyentantrieu.info/i2tree/index.php/cloud_storage/add_info_node',data, f);
		}
	</script>
</body>
</html>