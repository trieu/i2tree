<html>
<head>
	<meta http-equiv="Content-Type" content="text/html; charset=UTF-8" >
	<title>i2tree Collector</title>
	
	<link rel="stylesheet"	href="http://ajax.googleapis.com/ajax/libs/jqueryui/1.8.16/themes/base/jquery-ui.css" type="text/css" media="all" />
	<style type="text/css">
		body {	font-size: 98.5%;	}		
		body {	font-family: "Trebuchet MS", "Helvetica", "Arial", "Verdana", "sans-serif";	}
		#search_results { margin: 10px 0px;	}
		#search_results > .record {	padding: 10px;	}
		#search_results > .record:HOVER { background: #F5DA81; color: #0404B4; }
	</style>

	<script type="text/javascript" src="http://ajax.googleapis.com/ajax/libs/jquery/1.6.4/jquery.min.js"></script>
	<script type="text/javascript" src="http://ajax.googleapis.com/ajax/libs/jqueryui/1.8.16/jquery-ui.min.js"></script>
	<script type="text/javascript">
		$.extend({
		  getUrlVars: function(){
		    var vars = [], hash;
		    var hashes = window.location.href.slice(window.location.href.indexOf('?') + 1).split('&');
		    for(var i = 0; i < hashes.length; i++)
		    {
		      hash = hashes[i].split('=');
		      vars.push(hash[0]);
		      vars[hash[0]] = decodeURIComponent(hash[1]);
		    }
		    return vars;
		  },
		  getUrlVar: function(name){
		    return $.getUrlVars()[name];
		  }
		});
	</script>
	<script src="http://ajax.microsoft.com/ajax/jquery.templates/beta1/jquery.tmpl.min.js"></script>
</head>
<body>
	
	<div id="search_results" contenteditable="true"></div>
	
	<a href="javascript:addInfoNode(this)" >addInfoNode</a>
	<img id="ajax_loader" style="display:none;" src="http://drupal.org/files/54640843-ajax-style-loading-gif-animation.gif" />
	
	<script id="searchRecordTpl" type="text/x-jquery-tmpl"> 
    	<div class="record" >
			<a href="${url}" target="_blank"  ><b>${title}</b> </a>
			<p>${description}</p>
			{{each tags}}
        		${$index + 1}: <b>${$value}</b>
   			{{/each}}
		</div> 
	</script>
	
	<script type="text/javascript">	
		var check_status = false;
		var statusUrl = 'http://localhost/index.php/cloud_storage/check_status';
		jQuery.get(statusUrl,{},function(rs) {
			if(rs === 'false'){
				var myWindow = window.open(statusUrl + '?web_login=true');
				var callback = function(){
					check_status = true;
				};
				function pollForWindowClosure(){
					if(myWindow.closed){
						callback();
						return;
					}
					setTimeout(pollForWindowClosure, 10);
				}
				pollForWindowClosure();
				myWindow.focus();
			} else {
				check_status = true;
			}
		} );
		
		chrome.extension.onRequest.addListener(
			function(request, sender, sendResponse) {
				if(check_status){
					jQuery('#search_results').html(request.html);
				}
			}
		);
		
		function addInfoNode(){
			jQuery('#ajax_loader').show();
			var f = function(rs){
				jQuery('#ajax_loader').hide();
			};
			jQuery.post('http://localhost/index.php/cloud_storage/add_info_node',{text: jQuery('#search_results').html() }, f);
		}
	</script>
</body>
</html>